<h1>æ–°è¦ãƒ«ãƒ¼ãƒˆä½œæˆ</h1>

<%= form_with(model: @route, local: true, html: { multipart: true }) do |f| %>
  <%= hidden_field_tag "route[waypoints]", @route.waypoints.to_json.presence || "[]", id: "route_waypoints" %>

  <p>
    <%= f.label :title, "ã‚¿ã‚¤ãƒˆãƒ«" %><br>
    <%= f.text_field :title %>
  </p>

  <p>
    <%= f.label :description, "èª¬æ˜" %><br>
    <%= f.text_area :description %>
  </p>

  <p>
    <%= f.label :distance, "è·é›¢(km)" %><br>
    <%= f.number_field :distance %>
  </p>

  <p>
    <%= f.label :start_location, "é–‹å§‹åœ°ç‚¹" %><br>
    <%= f.text_field :start_location %>
  </p>

  <p>
    <%= f.label :end_location, "çµ‚äº†åœ°ç‚¹" %><br>
    <%= f.text_field :end_location %>
  </p>

  <!-- app/views/routes/_form.html.erb (éƒ¨åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–ã—ã¦ã„ã‚‹å ´åˆ) -->
<p>
  <%= f.label :latitude, "ç·¯åº¦" %><br>
  <%= f.number_field :latitude, step: 0.000001 %>
</p>

<p>
  <%= f.label :longitude, "çµŒåº¦" %><br>
  <%= f.number_field :longitude, step: 0.000001 %>
</p>

<!-- â˜… é–‹å§‹åœ°ç‚¹ï¼ˆstart_lat, start_lngï¼‰ -->
  <p>
    <%= f.label :start_lat, "å§‹ç‚¹ ç·¯åº¦" %><br>
    <%= f.number_field :start_lat, step: 0.000001, id: "startLat" %>
  </p>

  <p>
    <%= f.label :start_lng, "å§‹ç‚¹ çµŒåº¦" %><br>
    <%= f.number_field :start_lng, step: 0.000001, id: "startLng" %>
  </p>

  <!-- â˜… çµ‚äº†åœ°ç‚¹ï¼ˆend_lat, end_lngï¼‰ -->
  <p>
    <%= f.label :end_lat, "çµ‚ç‚¹ ç·¯åº¦" %><br>
    <%= f.number_field :end_lat, step: 0.000001, id: "endLat" %>
  </p>

  <p>
    <%= f.label :end_lng, "çµ‚ç‚¹ çµŒåº¦" %><br>
    <%= f.number_field :end_lng, step: 0.000001, id: "endLng" %>
  </p>



  <p>
  <%= f.label :image, "ãƒ«ãƒ¼ãƒˆã®å†™çœŸ" %><br>
  <%= f.file_field :image %>
  </p>


<!-- ãƒ«ãƒ¼ãƒˆã‚’æç”»ãƒœã‚¿ãƒ³ -->
  <button id="drawRoute" type="button">ãƒ«ãƒ¼ãƒˆã‚’æç”»</button>

  <div id="map" style="height: 400px; margin-top: 1rem;"></div>
  <button id="resetRoute" type="button">ãƒªã‚»ãƒƒãƒˆ</button>



  <p>
    <%= f.submit "ç™»éŒ²" %>
  </p>
<% end %>



<script>
  let alreadyInitialized = false;

  document.addEventListener("turbo:load", () => {
    if (alreadyInitialized) return;
    alreadyInitialized = true;

    console.log("ğŸ”¥ Turbo is working!");

    const mapElement = document.getElementById("map");
    if (!mapElement) return;

    if (window.myMap) {
      window.myMap.remove();
      window.myMap = null;
    }

    window.myMap = L.map("map").setView([35.681236, 139.767125], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(window.myMap);

    // ğŸ’¡ å¿…ãšã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©
    window.waypoints = [];
    window.markers = [];
    window.polyline = null;

    const waypointsInput = document.getElementById("route_waypoints");

    // ğŸš€ åˆæœŸå€¤ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã“ã“ãŒè¶…é‡è¦ï¼‰
    if (waypointsInput?.value) {
      try {
        const parsed = JSON.parse(waypointsInput.value);
        if (Array.isArray(parsed)) {
          window.waypoints = parsed.filter(p => typeof p === "object" && "lat" in p && "lng" in p);
        }
      } catch (e) {
        console.warn("ğŸ“› JSON parse failed", e);
      }
    }

    window.drawPolylineAndMarkers = function () {
      const map = window.myMap;
      const waypoints = window.waypoints;

      if (!map || !Array.isArray(waypoints)) {
        console.warn("â— mapã¾ãŸã¯waypointsãŒæœªå®šç¾©ã€‚æç”»ã‚’ä¸­æ­¢");
        return;
      }

      // å‰ã® polyline å‰Šé™¤
      if (window.polyline && map.hasLayer(window.polyline)) {
        map.removeLayer(window.polyline);
      }

      // å‰ã®ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
      if (Array.isArray(window.markers)) {
        window.markers.forEach(marker => {
          if (marker && map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        });
      }
      window.markers = [];

      // æœ‰åŠ¹ãªlatlngsã®ã¿æŠ½å‡ºï¼ˆå¿µã®ãŸã‚å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³è€ƒæ…®ï¼‰
      const latlngs = waypoints
        .map(p => {
          const lat = parseFloat(p.lat ?? p.latitude ?? p["lat"]);
          const lng = parseFloat(p.lng ?? p.longitude ?? p["lng"]);
          return (!isNaN(lat) && !isNaN(lng)) ? [lat, lng] : null;
        })
        .filter(p => Array.isArray(p) && p.length === 2);

      console.log("ğŸ¯ latlngs (Polylineç”¨):", latlngs);
      console.log("ğŸ§ª ç”Ÿã®waypoints:", waypoints);

      // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
      latlngs.forEach((coords, i) => {
        const marker = L.marker(coords).addTo(map).bindPopup(`åœ°ç‚¹ ${i + 1}`);
        window.markers.push(marker);
      });

      // ç·šã‚’å¼•ãï¼ˆ2ç‚¹ä»¥ä¸Šã®ã¨ãã ã‘ï¼‰
      if (latlngs.length >= 2) {
        try {
          window.polyline = L.polyline(latlngs, { color: "blue" }).addTo(map);
        } catch (e) {
          console.warn("ğŸ”¥ polyline error:", e, latlngs);
        }
      }
    };



    function updateHiddenInput() {
      if (waypointsInput) {
        waypointsInput.value = JSON.stringify(window.waypoints);
        console.log("ğŸ’¾ hiddenæ›´æ–°:", window.waypoints);
      }
    }

    // ğŸ–±ï¸ ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯æ™‚
    window.myMap.on("click", (e) => {
      window.waypoints.push({ lat: e.latlng.lat, lng: e.latlng.lng });
      updateHiddenInput();
      drawPolylineAndMarkers();
    });

    // ğŸ” ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    const resetBtn = document.getElementById("resetRoute");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        window.waypoints = [];
        updateHiddenInput();
        drawPolylineAndMarkers();
      });
    }

    // âœ… é…å»¶æç”»ï¼ˆTurboæç”»å®Œäº†å¾Œï¼‰
    setTimeout(() => {
      window.myMap.invalidateSize();
      drawPolylineAndMarkers();
    }, 300);
  });

  // ğŸ’¡ ãƒšãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰ã«Mapå‰Šé™¤
  document.addEventListener("turbo:before-cache", () => {
    if (window.myMap) {
      window.myMap.remove();
      window.myMap = null;
    }
    window.waypoints = []; // ğŸ‘ˆ ã“ã“ã‚‚çµ¶å¯¾ã‚¯ãƒªã‚¢ã™ã‚‹
    window.polyline = null;
    window.markers = [];
    alreadyInitialized = false;
  });

  // ğŸ” Turboå†æç”»æ™‚ã®è¿½åŠ ãƒ•ã‚©ãƒ­ãƒ¼ï¼ˆå¿µã®ãŸã‚ï¼‰
  document.addEventListener("turbo:render", () => {
    if (window.myMap) {
      window.myMap.invalidateSize();
      if (typeof window.drawPolylineAndMarkers === "function") {
        window.drawPolylineAndMarkers();
      }
    }
  });

</script>
