<h1 class="text-2xl font-bold mb-6 text-center">æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ</h1>

<div class="max-w-2xl mx-auto px-4">
  <%= form_with(model: @route, local: true, html: { multipart: true, class: "space-y-6" }) do |f| %>
    <%= hidden_field_tag "route[waypoints]", @route.waypoints.to_json.presence || "[]", id: "route_waypoints" %>

    <% [:title, :description, :distance, :start_location, :end_location, :image].each do |field| %>
      <div class="mb-4">
        <%= f.label field, class: "block font-medium mb-1" %>
        <% input_class = "w-full border rounded px-3 py-2" + (@route.errors[field].any? ? " border-red-500 bg-red-50" : "") %>

        <% if field == :description %>
          <%= f.text_area field, rows: 4, class: input_class %>
        <% elsif field == :image %>
          <%= f.file_field field, class: input_class %>
        <% elsif field == :distance %>
          <%= f.number_field field, class: input_class %>
        <% else %>
          <%= f.text_field field, class: input_class %>
        <% end %>

        <% if @route.errors[field].any? %>
          <p class="text-sm text-red-500 mt-1"><%= @route.errors.full_messages_for(field).join(", ") %></p>
        <% end %>
      </div>
    <% end %>

    <div class="flex gap-4 items-center">
      <button id="resetRoute" type="button" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
        åœ°å›³ã‚’ãƒªã‚»ãƒƒãƒˆ
      </button>
    </div>

    <div id="map" class="rounded border mt-4" style="height: 400px;"></div>

    <div>
      <%= f.submit "ç™»éŒ²", class: "bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded mt-6" %>
    </div>
  <% end %>
</div>





<script>
  let alreadyInitialized = false;

  document.addEventListener("turbo:load", () => {
    if (alreadyInitialized) return;
    alreadyInitialized = true;

    console.log("ğŸ”¥ Turbo is working!");

    const mapElement = document.getElementById("map");
    if (!mapElement) return;

    if (window.myMap) {
      window.myMap.remove();
      window.myMap = null;
    }

    window.myMap = L.map("map").setView([35.681236, 139.767125], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(window.myMap);

    // ğŸ’¡ å¿…ãšã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©
    window.waypoints = [];
    window.markers = [];
    window.polyline = null;

    const waypointsInput = document.getElementById("route_waypoints");

    // ğŸš€ åˆæœŸå€¤ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã“ã“ãŒè¶…é‡è¦ï¼‰
    if (waypointsInput?.value) {
      try {
        const parsed = JSON.parse(waypointsInput.value);
        if (Array.isArray(parsed)) {
          window.waypoints = parsed.filter(p => typeof p === "object" && "lat" in p && "lng" in p);
        }
      } catch (e) {
        console.warn("ğŸ“› JSON parse failed", e);
      }
    }

    window.drawPolylineAndMarkers = function () {
      const map = window.myMap;
      const waypoints = window.waypoints;

      if (!map || !Array.isArray(waypoints)) {
        console.warn("â— mapã¾ãŸã¯waypointsãŒæœªå®šç¾©ã€‚æç”»ã‚’ä¸­æ­¢");
        return;
      }

      // å‰ã® polyline å‰Šé™¤
      if (window.polyline && map.hasLayer(window.polyline)) {
        map.removeLayer(window.polyline);
      }

      // å‰ã®ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
      if (Array.isArray(window.markers)) {
        window.markers.forEach(marker => {
          if (marker && map.hasLayer(marker)) {
            map.removeLayer(marker);
          }
        });
      }
      window.markers = [];

      // æœ‰åŠ¹ãªlatlngsã®ã¿æŠ½å‡ºï¼ˆå¿µã®ãŸã‚å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³è€ƒæ…®ï¼‰
      const latlngs = waypoints
        .map(p => {
          const lat = parseFloat(p.lat ?? p.latitude ?? p["lat"]);
          const lng = parseFloat(p.lng ?? p.longitude ?? p["lng"]);
          return (!isNaN(lat) && !isNaN(lng)) ? [lat, lng] : null;
        })
        .filter(p => Array.isArray(p) && p.length === 2);

      console.log("ğŸ¯ latlngs (Polylineç”¨):", latlngs);
      console.log("ğŸ§ª ç”Ÿã®waypoints:", waypoints);

      // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
      latlngs.forEach((coords, i) => {
        const marker = L.marker(coords).addTo(map).bindPopup(`åœ°ç‚¹ ${i + 1}`);
        window.markers.push(marker);
      });

      // ç·šã‚’å¼•ãï¼ˆ2ç‚¹ä»¥ä¸Šã®ã¨ãã ã‘ï¼‰
      if (latlngs.length >= 2) {
        try {
          window.polyline = L.polyline(latlngs, { color: "blue" }).addTo(map);
        } catch (e) {
          console.warn("ğŸ”¥ polyline error:", e, latlngs);
        }
      }
    };



    function updateHiddenInput() {
      if (waypointsInput) {
        waypointsInput.value = JSON.stringify(window.waypoints);
        console.log("ğŸ’¾ hiddenæ›´æ–°:", window.waypoints);
      }
    }

    // ğŸ–±ï¸ ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯æ™‚
    window.myMap.on("click", (e) => {
      window.waypoints.push({ lat: e.latlng.lat, lng: e.latlng.lng });
      updateHiddenInput();
      drawPolylineAndMarkers();
    });

    // ğŸ” ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    const resetBtn = document.getElementById("resetRoute");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        window.waypoints = [];
        updateHiddenInput();
        drawPolylineAndMarkers();
      });
    }

    // âœ… é…å»¶æç”»ï¼ˆTurboæç”»å®Œäº†å¾Œï¼‰
    setTimeout(() => {
      window.myMap.invalidateSize();
      drawPolylineAndMarkers();
    }, 300);
  });

  // ğŸ’¡ ãƒšãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰ã«Mapå‰Šé™¤
  document.addEventListener("turbo:before-cache", () => {
    if (window.myMap) {
      window.myMap.remove();
      window.myMap = null;
    }
    window.waypoints = []; // ğŸ‘ˆ ã“ã“ã‚‚çµ¶å¯¾ã‚¯ãƒªã‚¢ã™ã‚‹
    window.polyline = null;
    window.markers = [];
    alreadyInitialized = false;
  });

  // ğŸ” Turboå†æç”»æ™‚ã®è¿½åŠ ãƒ•ã‚©ãƒ­ãƒ¼ï¼ˆå¿µã®ãŸã‚ï¼‰
  document.addEventListener("turbo:render", () => {
    if (window.myMap) {
      window.myMap.invalidateSize();
      if (typeof window.drawPolylineAndMarkers === "function") {
        window.drawPolylineAndMarkers();
      }
    }
  });

</script>
