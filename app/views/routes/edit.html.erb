<div class="max-w-3xl mx-auto px-4 py-8 space-y-8">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">ãƒ«ãƒ¼ãƒˆã‚’ç·¨é›†</h1>

  <%= form_with(model: @route, local: true, html: { multipart: true, class: "space-y-6" }) do |f| %>
    <div>
      <%= f.label :title, "ã‚¿ã‚¤ãƒˆãƒ«", class: "block font-semibold mb-1" %>
      <%= f.text_field :title, class: "w-full border rounded px-3 py-2" %>
    </div>

    <div>
      <%= f.label :description, "èª¬æ˜", class: "block font-semibold mb-1" %>
      <%= f.text_area :description, rows: 3, class: "w-full border rounded px-3 py-2" %>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <%= f.label :distance, "è·é›¢ (km)", class: "block font-semibold mb-1" %>
        <%= f.number_field :distance, class: "w-full border rounded px-3 py-2" %>
      </div>
      <div>
        <%= f.label :image, "ãƒ«ãƒ¼ãƒˆã®å†™çœŸ", class: "block font-semibold mb-1" %>
        <%= f.file_field :image, class: "w-full border rounded px-3 py-2" %>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <%= f.label :start_location, "é–‹å§‹åœ°ç‚¹", class: "block font-semibold mb-1" %>
        <%= f.text_field :start_location, class: "w-full border rounded px-3 py-2" %>
      </div>
      <div>
        <%= f.label :end_location, "çµ‚äº†åœ°ç‚¹", class: "block font-semibold mb-1" %>
        <%= f.text_field :end_location, class: "w-full border rounded px-3 py-2" %>
      </div>
    </div>

    <%= hidden_field_tag "waypoints", @route.waypoints.to_json, id: "waypointsInput" %>

    <div>
      <div id="map" class="rounded border" style="height: 400px;"></div>
      <button id="resetRoute" type="button" class="mt-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
        åœ°å›³ã‚’ãƒªã‚»ãƒƒãƒˆ
      </button>
    </div>

    <div>
      <%= f.submit "æ›´æ–°ã™ã‚‹", class: "bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded" %>
    </div>
  <% end %>

  <div class="mt-4">
    <%= link_to "ä¸€è¦§ã«æˆ»ã‚‹", routes_path, class: "text-blue-600 hover:underline" %>
  </div>
</div>


<script>
  document.addEventListener("turbo:load", () => {
    const mapElement = document.getElementById("map");
    if (!mapElement) return;

    // å¤ã„ãƒãƒƒãƒ—ã®å‰Šé™¤
    if (window.myMap && typeof window.myMap.remove === "function") {
      window.myMap.remove();
    }

    // åœ°å›³ã‚’åˆæœŸåŒ–
    const map = L.map("map").setView([35.681236, 139.767125], 13);
    window.myMap = map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "Â© OpenStreetMap",
    }).addTo(map);

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    let waypoints = [];
    try {
      const hidden = document.getElementById("waypointsInput");
      if (hidden && hidden.value) {
        const parsed = JSON.parse(hidden.value);
        if (Array.isArray(parsed)) {
          waypoints = parsed;
        }
      }
    } catch (e) {
      console.warn("ğŸš« waypoints ã® JSON èª­ã¿è¾¼ã¿å¤±æ•—", e);
    }

    let polyline = null;
    let markers = [];

    function drawPolyline() {
      if (polyline) map.removeLayer(polyline);

      const latlngs = waypoints.map(p => {
        const lat = parseFloat(p.lat ?? p.latitude ?? p["lat"]);
        const lng = parseFloat(p.lng ?? p.longitude ?? p["lng"]);
        return (!isNaN(lat) && !isNaN(lng)) ? [lat, lng] : null;
      }).filter(p => Array.isArray(p) && p.length === 2);

      console.log("âœ… æœ€çµ‚çš„ãªlatlngs:", latlngs);

      if (latlngs.length >= 2) {
        polyline = L.polyline(latlngs, { color: "blue" }).addTo(map);
      }

      // ãƒãƒ¼ã‚«ãƒ¼ã‚‚æç”»ï¼ˆåˆæœŸåŒ–å¾Œã®å†æç”»ã‚‚å«ã‚ï¼‰
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      latlngs.forEach((coords, index) => {
        const marker = L.marker(coords)
          .addTo(map)
          .bindPopup(`åœ°ç‚¹ ${index + 1}`);
        markers.push(marker);
      });
    }

    function updateHiddenInput() {
      const input = document.getElementById("waypointsInput");
      if (!input) return;

      const clean = waypoints.map(p => {
        const lat = parseFloat(p.lat ?? p.latitude ?? p["lat"]);
        const lng = parseFloat(p.lng ?? p.longitude ?? p["lng"]);
        return (!isNaN(lat) && !isNaN(lng)) ? { lat, lng } : null;
      }).filter(p => p !== null);

      input.value = JSON.stringify(clean);
      console.log("ğŸ“¦ ä¿å­˜ç›´å‰ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¯ãƒªãƒ¼ãƒ³æ¸ˆï¼‰", clean);
    }

    // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
    map.on("click", function (e) {
      const latlng = e.latlng;
      waypoints.push({ lat: latlng.lat, lng: latlng.lng });
      drawPolyline();
      updateHiddenInput();
    });

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    const resetBtn = document.getElementById("resetRoute");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        waypoints = [];
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        if (polyline) {
          map.removeLayer(polyline);
          polyline = null;
        }
        updateHiddenInput();
      });
    }

    // åˆå›æç”»
    drawPolyline();
    updateHiddenInput();
  });
</script>
