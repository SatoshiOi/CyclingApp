<h1>ãƒ«ãƒ¼ãƒˆç·¨é›†</h1>

<%= form_with(model: @route, local: true, html: { multipart: true }) do |f| %>

  <p>
    <%= f.label :title, "ã‚¿ã‚¤ãƒˆãƒ«" %><br>
    <%= f.text_field :title %>
  </p>

  <p>
    <%= f.label :description, "èª¬æ˜" %><br>
    <%= f.text_area :description %>
  </p>

  <p>
    <%= f.label :distance, "è·é›¢(km)" %><br>
    <%= f.number_field :distance %>
  </p>

  <p>
    <%= f.label :start_location, "é–‹å§‹åœ°ç‚¹" %><br>
    <%= f.text_field :start_location %>
  </p>

  <p>
    <%= f.label :end_location, "çµ‚äº†åœ°ç‚¹" %><br>
    <%= f.text_field :end_location %>
  </p>

  <!-- app/views/routes/_form.html.erb (éƒ¨åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–ã—ã¦ã„ã‚‹å ´åˆ) -->
<p>
  <%= f.label :latitude, "ç·¯åº¦" %><br>
  <%= f.number_field :latitude, step: 0.000001 %>
</p>

<p>
  <%= f.label :longitude, "çµŒåº¦" %><br>
  <%= f.number_field :longitude, step: 0.000001 %>
</p>
 <!-- â˜… é–‹å§‹åœ°ç‚¹ï¼ˆstart_lat, start_lngï¼‰ -->
  <p>
    <%= f.label :start_lat, "å§‹ç‚¹ ç·¯åº¦" %><br>
    <%= f.number_field :start_lat, step: 0.000001, id: "startLat" %>
  </p>

  <p>
    <%= f.label :start_lng, "å§‹ç‚¹ çµŒåº¦" %><br>
    <%= f.number_field :start_lng, step: 0.000001, id: "startLng" %>
  </p>

  <!-- â˜… çµ‚äº†åœ°ç‚¹ï¼ˆend_lat, end_lngï¼‰ -->
  <p>
    <%= f.label :end_lat, "çµ‚ç‚¹ ç·¯åº¦" %><br>
    <%= f.number_field :end_lat, step: 0.000001, id: "endLat" %>
  </p>

  <p>
    <%= f.label :end_lng, "çµ‚ç‚¹ çµŒåº¦" %><br>
    <%= f.number_field :end_lng, step: 0.000001, id: "endLng" %>
  </p>




  <p>
  <%= f.label :image, "ãƒ«ãƒ¼ãƒˆã®å†™çœŸ" %><br>
  <%= f.file_field :image %>
  </p>


  <!-- ãƒ«ãƒ¼ãƒˆã‚’æç”»ãƒœã‚¿ãƒ³ -->
  <button id="drawRoute" type="button">ãƒ«ãƒ¼ãƒˆã‚’æç”»</button>

  <div id="map" style="height: 400px; margin-top: 1rem;"></div>


  <p>
    <%= f.submit "æ›´æ–°" %>
  </p>
<% end %>

<%= link_to "ä¸€è¦§ã«æˆ»ã‚‹", routes_path %>

<script>
  document.addEventListener("turbo:load", () => {
    const mapElement = document.getElementById("map");
    if (!mapElement) return;

    // å¤ã„ãƒãƒƒãƒ—ã®å‰Šé™¤
    if (window.myMap && typeof window.myMap.remove === "function") {
      window.myMap.remove();
    }

    // åœ°å›³ã‚’åˆæœŸåŒ–
    const map = L.map("map").setView([35.681236, 139.767125], 13);
    window.myMap = map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "Â© OpenStreetMap",
    }).addTo(map);

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    let waypoints = [];
    try {
      const hidden = document.getElementById("waypointsInput");
      if (hidden && hidden.value) {
        const parsed = JSON.parse(hidden.value);
        if (Array.isArray(parsed)) {
          waypoints = parsed;
        }
      }
    } catch (e) {
      console.warn("ğŸš« waypoints ã® JSON èª­ã¿è¾¼ã¿å¤±æ•—", e);
    }

    let polyline = null;
    let markers = [];

    function drawPolyline() {
      if (polyline) map.removeLayer(polyline);

      const latlngs = waypoints.map(p => {
        const lat = parseFloat(p.lat ?? p.latitude ?? p["lat"]);
        const lng = parseFloat(p.lng ?? p.longitude ?? p["lng"]);
        return (!isNaN(lat) && !isNaN(lng)) ? [lat, lng] : null;
      }).filter(p => Array.isArray(p) && p.length === 2);

      console.log("âœ… æœ€çµ‚çš„ãªlatlngs:", latlngs);

      if (latlngs.length >= 2) {
        polyline = L.polyline(latlngs, { color: "blue" }).addTo(map);
      }

      // ãƒãƒ¼ã‚«ãƒ¼ã‚‚æç”»ï¼ˆåˆæœŸåŒ–å¾Œã®å†æç”»ã‚‚å«ã‚ï¼‰
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
      latlngs.forEach((coords, index) => {
        const marker = L.marker(coords)
          .addTo(map)
          .bindPopup(`åœ°ç‚¹ ${index + 1}`);
        markers.push(marker);
      });
    }

    function updateHiddenInput() {
      const input = document.getElementById("waypointsInput");
      if (!input) return;

      const clean = waypoints.map(p => {
        const lat = parseFloat(p.lat ?? p.latitude ?? p["lat"]);
        const lng = parseFloat(p.lng ?? p.longitude ?? p["lng"]);
        return (!isNaN(lat) && !isNaN(lng)) ? { lat, lng } : null;
      }).filter(p => p !== null);

      input.value = JSON.stringify(clean);
      console.log("ğŸ“¦ ä¿å­˜ç›´å‰ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¯ãƒªãƒ¼ãƒ³æ¸ˆï¼‰", clean);
    }

    // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
    map.on("click", function (e) {
      const latlng = e.latlng;
      waypoints.push({ lat: latlng.lat, lng: latlng.lng });
      drawPolyline();
      updateHiddenInput();
    });

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    const resetBtn = document.getElementById("resetRoute");
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        waypoints = [];
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        if (polyline) {
          map.removeLayer(polyline);
          polyline = null;
        }
        updateHiddenInput();
      });
    }

    // åˆå›æç”»
    drawPolyline();
    updateHiddenInput();
  });
</script>
